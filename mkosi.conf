[Distribution]
Distribution=debian
Release=trixie

[Output]
Format=cpio
CompressOutput=zstd
CompressLevel=19
OutputDirectory=mkosi.output

[Build]
ToolsTree=yes
Incremental=yes
CacheDirectory=mkosi.cache

[Content]
Bootable=no
CleanPackageMetadata=yes
Autologin=yes
# Skips installing documentation/man pages
WithDocs=no
# Prevents the package manager from keeping a cache inside the image
CachePackages=no

# Do NOT set MakeInitrd=yes — that adds /etc/initrd-release which causes
# systemd to enter initrd mode and try switch-root to a real rootfs.
# CaptainOS uses a custom /init script (mkosi.extra/init) that transitions
# rootfs → tmpfs via switch_root before exec'ing systemd. This makes
# pivot_root(2) work for container runtimes (runc).

# Inject pre-built kernel and modules (built by scripts/build-kernel.sh)
ExtraTrees=mkosi.output/kernel

Packages=
    # systemd and core
    systemd
    systemd-sysv # Provides poweroff, shutdown, reboot, halt, etc.
    systemd-resolved
    systemd-timesyncd
    udev
    dbus
    kmod
    dmsetup
    acpid
    # Shell and basic userspace
    bash
    login
    less
    util-linux
    procps
    coreutils
    findutils
    grep
    sed
    # Filesystem
    # e2fsprogs
    # dosfstools
    # lvm2
    # mdadm
    # Networking
    iproute2
    iputils-ping
    iptables
    nftables
    #curl
    ca-certificates
    # Container runtime: containerd 2.x and runc downloaded in download-tools.sh
    # Storage / provisioning tools
    # Compression
    pigz
    #zstd
    #xz-utils

# Kernel modules to include in the initrd
KernelModulesInitrd=yes
KernelModulesInitrdInclude=
    # Virtio (for testing in QEMU)
    virtio_net
    virtio_blk
    virtio_scsi
    virtio_pci
    virtio_console
    # Network drivers (common bare-metal)
    e1000e
    igb
    igc
    ixgbe
    i40e
    ice
    mlx4_en
    mlx5_core
    bnxt_en
    tg3
    r8169
    # Block / storage
    ahci
    nvme
    sd_mod
    usb_storage
    xhci_hcd
    xhci_pci
    ehci_hcd
    uas
    megaraid_sas
    mpt3sas
    hpsa
    # Filesystem
    ext4
    vfat
    overlay
    # Container networking
    veth
    bridge
    br_netfilter
    nf_nat
    nf_conntrack
    xt_conntrack
    xt_addrtype
    xt_comment
    xt_mark
    xt_MASQUERADE
    ip_tables
    ip6_tables
    # Device mapper
    dm_mod
    dm_crypt
    dm_thin_pool
    # Other
    loop
    nbd
    tun
    tap

KernelModulesInitrdExclude=
    # Exclude GPU/sound/media to save space
    /drivers/gpu/
    /drivers/media/
    /sound/
    /drivers/infiniband/
    /drivers/isdn/
    /drivers/bluetooth/
    /drivers/nfc/
    /drivers/staging/

RemoveFiles=
    /etc/initrd-release
    /usr/share/doc
    /usr/share/man
    /usr/share/info
    /usr/share/locale
    /usr/share/i18n
    /usr/share/zoneinfo
    /var/cache
    /var/log
    /usr/share/bash-completion
    /usr/share/zsh
    /usr/lib/udev/hwdb.d
    /usr/share/lintian
    /usr/share/bug
    /usr/share/pixmaps
    /usr/share/applications
    /usr/share/icons
    /usr/share/polkit-1
    /usr/lib/systemd/catalog
    /var/lib/systemd/catalog
    /usr/lib/systemd/system/systemd-firstboot.service
    /usr/lib/systemd/system/sysinit.target.wants/systemd-firstboot.service
