# CaptainOS rsyslog configuration
# Forward journal entries and container logs to a remote syslog server via UDP.

# Increase max message size to handle large JSON log lines (e.g., hardware attributes)
$MaxMessageSize 8192

# Disable local file logging (no /var/log in this image)
$ModLoad imjournal

# Filter journal to only tink-agent and tink-agent-setup units
if ($!_SYSTEMD_UNIT == "tink-agent.service" or $!_SYSTEMD_UNIT == "tink-agent-setup.service") then {
    action(type="omfwd"
        target=`echo $SYSLOG_HOST`
        port=`echo $SYSLOG_PORT`
        protocol="udp"
        template="RSYSLOG_SyslogProtocol23Format"
    )
}

# Tail containerd container log files (task stdout/stderr)
module(load="imfile")
input(type="imfile"
    File="/var/lib/containerd/io.containerd.grpc.v2.task/*/log"
    Tag="container"
    Severity="info"
    Facility="local0"
    addMetadata="on"
)

# Forward container logs
if ($syslogtag startswith "container") then {
    action(type="omfwd"
        target=`echo $SYSLOG_HOST`
        port=`echo $SYSLOG_PORT`
        protocol="udp"
        template="RSYSLOG_SyslogProtocol23Format"
    )
}

# Discard everything else (no local logging)
*.* stop
