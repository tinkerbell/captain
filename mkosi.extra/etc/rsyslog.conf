# CaptainOS rsyslog configuration
# Replaces the Debian default. Only forwards filtered logs to a remote
# syslog server via UDP — no local file logging, no imuxsock/imklog.

# ── Global settings ──────────────────────────────────────────────────
# Increase max message size to handle large JSON log lines
# (e.g., tink-agent hardware attribute payloads).
global(
    maxMessageSize="8192"
    workDirectory="/run/rsyslog"
)

# ── Inputs ───────────────────────────────────────────────────────────
# Read the systemd journal. Do NOT load imuxsock or imklog — we only
# want journal entries from specific units, not all daemon syslog output.
module(load="imjournal")

# Tail containerd container log files (workflow action stdout/stderr).
module(load="imfile")
input(type="imfile"
    File="/var/lib/containerd/io.containerd.grpc.v2.task/*/log"
    Tag="container"
    Severity="info"
    Facility="local0"
    addMetadata="on"
)

# ── Forwarding rules ────────────────────────────────────────────────
# Forward tink-agent and tink-agent-setup journal entries
if ($!_SYSTEMD_UNIT == "tink-agent.service" or $!_SYSTEMD_UNIT == "tink-agent-setup.service") then {
    action(type="omfwd"
        target=`echo $SYSLOG_HOST`
        port=`echo $SYSLOG_PORT`
        protocol="udp"
        template="RSYSLOG_SyslogProtocol23Format"
    )
}

# Forward container logs (from imfile).
# Match "container:" specifically — NOT "containerd" (the daemon).
if ($syslogtag startswith "container:") then {
    action(type="omfwd"
        target=`echo $SYSLOG_HOST`
        port=`echo $SYSLOG_PORT`
        protocol="udp"
        template="RSYSLOG_SyslogProtocol23Format"
    )
}

# Discard everything else (no local logging)
*.* stop
